// --- Меню бургер ---
(function () {
    const $body = document.querySelector('body');
    const $menu = $body.querySelector('.main-nav');
    const $buttonToggle = $menu.querySelector('.main-nav__toggle');

    const onButtonToggleClick = function(evt) {
        evt.preventDefault();

        $menu.classList.toggle('main-nav--active');
        $body.classList.toggle('lock');
    }
    
    $buttonToggle.addEventListener('click', onButtonToggleClick);
})();

// --- Модальное окно ---
(function () {
    const modalLinks = document.querySelectorAll('.toggle-modal');
    const body = document.querySelector('body');
    const modalCloseIcon = document.querySelectorAll('.js-close-modal');
    const focusableElements = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
    const lockPadding = document.querySelectorAll('.lock-padding');
    const timeout = 400;
    let lockPaddingValue = window.innerWidth - body.offsetWidth + 'px';
    let unlock = true;

    const bodyLock = function () {
        /* Для фикса фиксированной шапки */
        if (lockPadding.length > 0) {
            for (let index = 0; index < lockPadding.length; index++) {
                const el = lockPadding[index];
                el.style.paddingRight = lockPaddingValue;
            }
        }
        body.style.paddingRight = lockPaddingValue;
        body.classList.add('lock');

        unlock = false;
        setTimeout(function () {
            unlock = true;
        }, timeout);
    }

    const bodyUnLock = function () {
        setTimeout(function () {
            if (lockPadding.length > 0) {
                for (let index = 0; index < lockPadding.length; index++) {
                    const el = lockPadding[index];
                    el.style.paddingRight = '0px';
                }
            }
            body.style.paddingRight = '0px';
            body.classList.remove('lock');
        }, timeout);

        unlock = false;
        setTimeout(function () {
            unlock = true;
        }, timeout);
    }

    const modalClose = function(modalActive, doUnlock = true) {
        if (unlock) {
            modalActive.classList.remove('modal--active');
            modalActive.removeEventListener('mousedown', onModalOutsideClick);
            document.removeEventListener('keydown', onModalEscPress);
            if (doUnlock) {
                bodyUnLock();
            }
        }
    }

    if (modalCloseIcon.length > 0) {
        for (let index = 0; index < modalCloseIcon.length; index++) {
            const el = modalCloseIcon[index];
            el.addEventListener('click', function (evt) {
                modalClose(el.closest('.modal'));
                evt.preventDefault();
            });
        }
    }

    const onModalEscPress = function (evt) {
        if (evt.keyCode === 27 || evt.code === 'Escape') {
            const modalActive = document.querySelector('.modal.modal--active');
            modalClose(modalActive);
        }
    }

    const onModalOutsideClick = function (evt) {
        if (!evt.target.closest('.modal__content')) {
            modalClose(evt.target.closest('.modal'));
        }
    }

    const onModalTabClick = function (evt) {
        const isTabPressed = evt.key === 'Tab' || evt.keyCode === 9;
        const firstFocusableElement = this.querySelectorAll(focusableElements)[0];
        const focusableContent = this.querySelectorAll(focusableElements);
        const lastFocusableElement =
            focusableContent[focusableContent.length - 1];

        if (!isTabPressed) {
            return;
        }

        if (evt.shiftKey) {
            if (document.activeElement === firstFocusableElement) {
                lastFocusableElement.focus();
                evt.preventDefault();
            }
        } else {
            if (document.activeElement === lastFocusableElement) {
                firstFocusableElement.focus();
                evt.preventDefault();
            }
        }
    }

    const modalOpen = function (curentModal) {
        const firstFocusableElement = curentModal.querySelectorAll(focusableElements)[0];

        if (curentModal && unlock) {
            let modalActive = document.querySelector('.modal.modal--active');
            if (modalActive) {
                modalClose(modalActive, false);
            } else {
                bodyLock();
            }
            curentModal.classList.add('modal--active');
            curentModal.addEventListener('mousedown', onModalOutsideClick);
            document.addEventListener('keydown', onModalEscPress);
            curentModal.addEventListener('keydown', onModalTabClick);

            setTimeout(function () {
                firstFocusableElement.focus();
                firstFocusableElement.blur();
            }, timeout);
        }
    }

    const onModalLinkClick = function(evt) {
        evt.preventDefault();
        const modalName = this.getAttribute('data-target');
        const curentModal = document.querySelector(modalName);
        modalOpen(curentModal);
    }

    if (modalLinks.length > 0) {
        for (let index = 0; index < modalLinks.length; index++) {
            const modalLink = modalLinks[index];
            modalLink.addEventListener('click', onModalLinkClick);
        }
    }
})();

// --- Табы ---
(function () {

    const tabs = document.querySelectorAll('.tabs');

    tabs.forEach((tab) => {
        const tabButtons = tab.querySelectorAll('.tabs-nav__btn');
        const tabItems = tab.querySelectorAll('.tabs-content__item');

        tabButtons.forEach((tabButton, index) => {
            tabButton.addEventListener('click', function (evt) {
                evt.preventDefault();

                if (!tabButton.classList.contains('tabs-nav__btn--active')) {
                    tabButtons.forEach((tabButton, index) => {
                        tabButton.classList.remove('tabs-nav__btn--active');
                        tabItems[index].classList.remove('tabs-content__item--active');
                    });

                    tabButton.classList.add('tabs-nav__btn--active');
                    tabItems[index].classList.add('tabs-content__item--active');
                }

            });
        });

    });

})();

// --- Спойлеры ---
(function () {
    
    const slideUp = (target, duration = 500) => {
        target.style.transitionProperty = 'height, margin, padding';
        target.style.transitionDuration = duration + 'ms';
        target.style.height = target.offsetHeight + 'px';
        target.offsetHeight;
        target.style.overflow = 'hidden';
        target.style.height = 0;
        target.style.paddingTop = 0;
        target.style.paddingBottom = 0;
        target.style.marginTop = 0;
        target.style.marginBottom = 0;
        window.setTimeout(() => {
            target.style.display = 'none';
            target.style.removeProperty('height');
            target.style.removeProperty('padding-top');
            target.style.removeProperty('padding-bottom');
            target.style.removeProperty('margin-top');
            target.style.removeProperty('margin-bottom');
            target.style.removeProperty('overflow');
            target.style.removeProperty('transition-duration');
            target.style.removeProperty('transition-property');
            target.classList.remove('spollers-item__content--slide');
        }, duration);
    }

    const slideDown = (target, duration = 500) => {
        target.style.removeProperty('display');
        let display = window.getComputedStyle(target).display;
        if (display === 'none') display = 'block';
        target.style.display = display;
        const height = target.offsetHeight;
        target.style.overflow = 'hidden';
        target.style.height = 0;
        target.style.paddingTop = 0;
        target.style.paddingBottom = 0;
        target.style.marginTop = 0;
        target.style.marginBottom = 0;
        target.offsetHeight;
        target.style.transitionProperty = "height, margin, padding";
        target.style.transitionDuration = duration + 'ms';
        target.style.height = height + 'px';
        target.style.removeProperty('padding-top');
        target.style.removeProperty('padding-bottom');
        target.style.removeProperty('margin-top');
        target.style.removeProperty('margin-bottom');
        window.setTimeout(() => {
            target.style.removeProperty('height');
            target.style.removeProperty('overflow');
            target.style.removeProperty('transition-duration');
            target.style.removeProperty('transition-property');
            target.classList.remove('spollers-item__content--slide');
        }, duration);
    }

    const slideToggle = (target, duration = 500) => {
        if (!target.classList.contains('spollers-item__content--slide')) {
            target.classList.add('spollers-item__content--slide');
            window.getComputedStyle(target).display === 'none'
                ? slideDown(target, duration)
                : slideUp(target, duration);
        }
    }

    const spollers = document.querySelectorAll(".spoller");
    let canSlide = true;

    if (spollers.length > 0) {

        spollers.forEach(spoller => {
            spoller.addEventListener("click", function (evt) {
                evt.preventDefault();

                if (canSlide) {
                    canSlide = false;

                    if (spoller.closest('.spollers').classList.contains('spollers--one')) {
                        const curentSpollers = spoller.closest('.spollers').querySelectorAll('.spoller');

                        curentSpollers.forEach(curentSpoller => {
                            if (curentSpoller !== spoller) {
                                curentSpoller.classList.remove('spollers-item__btn--active');
                                slideUp(curentSpoller.nextElementSibling);
                            }
                        });

                    }

                    spoller.classList.toggle('spollers-item__btn--active');
                    slideToggle(spoller.nextElementSibling);

                    setTimeout(function () {
                        canSlide = true;
                    }, 500);
                }
            });
        });
    }

})();










let forms = document.querySelectorAll('form');
if (forms.length > 0) {
	for (let index = 0; index < forms.length; index++) {
		const el = forms[index];
		el.addEventListener('submit', form_submit);
	}
}
async function form_submit(e) {
	let btn = e.target;
	let form = btn.closest('form');
	let error = form_validate(form);
	if (error == 0) {
		let formAction = form.getAttribute('action') ? form.getAttribute('action').trim() : '#';
		let formMethod = form.getAttribute('method') ? form.getAttribute('method').trim() : 'GET';
		const message = form.getAttribute('data-message');
		const ajax = form.getAttribute('data-ajax');

		//SendForm
		if (ajax) {
			e.preventDefault();
			let formData = new FormData(form);
			form.classList.add('_sending');
			let response = await fetch(formAction, {
				method: formMethod,
				body: formData
			});
			if (response.ok) {
				let result = await response.json();
				form.classList.remove('_sending');
				if (message) {
					popup_open('_' + message + '-message');
				}
				form_clean(form);
			} else {
				alert("Ошибка");
				form.classList.remove('_sending');
			}
		}
	} else {
		let form_error = form.querySelectorAll('._error');
		if (form_error && form.classList.contains('_goto-error')) {
			_goto(form_error[0], 1000, 50);
		}
		e.preventDefault();
	}
}

function form_validate(form) {
	let error = 0;
	let form_req = form.querySelectorAll('._req');
	if (form_req.length > 0) {
		for (let index = 0; index < form_req.length; index++) {
			const el = form_req[index];
			if (!_is_hidden(el)) {
				error += form_validate_input(el);
			}
		}
	}
	return error;
}
function form_validate_input(input) {
	let error = 0;
	let input_g_value = input.getAttribute('data-value');

	if (input.getAttribute("name") == "email" || input.classList.contains("_email")) {
		if (input.value != input_g_value) {
			let em = input.value.replace(" ", "");
			input.value = em;
		}
		if (email_test(input) || input.value == input_g_value) {
			form_add_error(input);
			error++;
		} else {
			form_remove_error(input);
		}
	} else if (input.getAttribute("type") == "checkbox" && input.checked == false) {
		form_add_error(input);
		error++;
	} else {
		if (input.value == '' || input.value == input_g_value) {
			form_add_error(input);
			error++;
		} else {
			form_remove_error(input);
		}
	}
	return error;
}
function form_add_error(input) {
	input.classList.add('_error');
	input.parentElement.classList.add('_error');

	let input_error = input.parentElement.querySelector('.form__error');
	if (input_error) {
		input.parentElement.removeChild(input_error);
	}
	let input_error_text = input.getAttribute('data-error');
	if (input_error_text && input_error_text != '') {
		input.parentElement.insertAdjacentHTML('beforeend', '<div class="form__error">' + input_error_text + '</div>');
	}
}
function form_remove_error(input) {
	input.classList.remove('_error');
	input.parentElement.classList.remove('_error');

	let input_error = input.parentElement.querySelector('.form__error');
	if (input_error) {
		input.parentElement.removeChild(input_error);
	}
}
function form_clean(form) {
	let inputs = form.querySelectorAll('input,textarea');
	for (let index = 0; index < inputs.length; index++) {
		const el = inputs[index];
		el.parentElement.classList.remove('_focus');
		el.classList.remove('_focus');
		el.value = el.getAttribute('data-value');
	}
	let checkboxes = form.querySelectorAll('.checkbox__input');
	if (checkboxes.length > 0) {
		for (let index = 0; index < checkboxes.length; index++) {
			const checkbox = checkboxes[index];
			checkbox.checked = false;
		}
	}
	let selects = form.querySelectorAll('select');
	if (selects.length > 0) {
		for (let index = 0; index < selects.length; index++) {
			const select = selects[index];
			const select_default_value = select.getAttribute('data-default');
			select.value = select_default_value;
			select_item(select);
		}
	}
}

let viewPass = document.querySelectorAll('.form__viewpass');
for (let index = 0; index < viewPass.length; index++) {
	const element = viewPass[index];
	element.addEventListener("click", function (e) {
		if (element.classList.contains('_active')) {
			element.parentElement.querySelector('input').setAttribute("type", "password");
		} else {
			element.parentElement.querySelector('input').setAttribute("type", "text");
		}
		element.classList.toggle('_active');
	});
}
